<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hybrid System Calculator ‚Äì Macksons Solar</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #f8fafc;
      --accent: #06d6a0;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --card-bg: #ffffff;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      color: var(--text);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem;
      max-width: 900px;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
    }

    .select-wrapper, .input-wrapper {
      position: relative;
    }

    select, input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      background: var(--card-bg);
      transition: all 0.3s ease;
      font-family: inherit;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .row {
      display: flex;
      gap: 1rem;
    }

    .col {
      flex: 1;
    }

    @media (max-width: 700px) {
      .row {
        flex-direction: column;
      }
    }

    .calculate-btn {
      width: 100%;
      padding: 14px 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 1rem;
    }

    .calculate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
    }

    .calculate-btn:active {
      transform: translateY(0);
    }

    .result-card {
      margin-top: 1.5rem;
      padding: 1.5rem;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, #dbeafe, #e0e7ff);
      border: 1px solid #c7d2fe;
      display: none;
    }

    .result-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 0.5rem;
    }

    .result-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .result-details {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .home-btn {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: var(--secondary);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.85rem;
      transition: all 0.3s ease;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .home-btn:hover {
      background: var(--primary);
      color: white;
    }

    footer {
      margin-top: 2rem;
      text-align: right;
      color: var(--text-light);
      font-size: 0.85rem;
    }

    /* Animation for result */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-card.show {
      display: block;
      animation: slideIn 0.3s ease;
    }

    /* Info note styling */
    .info-note {
      background: #e8f4fd;
      border: 1px solid #3498db;
      border-radius: var(--radius-sm);
      padding: 1rem;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    code {
      background: rgba(99, 102, 241, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--primary-dark);
      font-weight: 500;
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.85rem;
    }

    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      font-weight: 600;
      background: rgba(99, 102, 241, 0.05);
    }

    tr:hover {
      background: rgba(99, 102, 241, 0.03);
    }

    /* Warning and success styling */
    .warn {
      color: #92400e;
      background: #fff7ed;
      padding: 12px;
      border-radius: var(--radius-sm);
      margin-top: 10px;
      border-left: 4px solid #f59e0b;
    }

    .ok {
      color: #064e3b;
      background: #ecfdf5;
      padding: 12px;
      border-radius: var(--radius-sm);
      margin-top: 10px;
      border-left: 4px solid #10b981;
    }

    hr {
      border: none;
      height: 1px;
      background: var(--border);
      margin: 1.5rem 0;
    }

    ul {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }

    li {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    /* Modern toggle switch for mode selection */
    .mode-toggle {
      display: flex;
      background: var(--secondary);
      border-radius: var(--radius-sm);
      padding: 4px;
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .mode-option {
      flex: 1;
      padding: 10px 16px;
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .mode-option.active {
      background: var(--primary);
      color: white;
    }

    /* Input with unit */
    .input-with-unit {
      position: relative;
    }

    .unit {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <div class="glass-card">
    <a href="index.html" class="home-btn">
      <span>üè†</span>
      <span>Home</span>
    </a>
    
    <div class="header">
      <div class="logo"> <img src="hybrid.png" width="45" height="45"> </div>
      <h1>Hybrid System Calculator</h1>
	  <h2 class="subtitle">Macksons Solar </h2>
      <p class="subtitle">Quickly recommend inverter & battery based on customer's house load. Change "Desired backup hours" if customer wants different autonomy.</p>
    </div>

    <div class="row">
      <div class="col">
        <div class="form-group">
          <label>System Phase</label>
          <select id="phase">
            <option value="single">Single Phase (Low Voltage)</option>
            <option value="three">Three Phase (High Voltage)</option>
          </select>
        </div>
      </div>
      <div class="col">
        <div class="form-group">
          <label>System Mode</label>
          <div class="mode-toggle">
            <div class="mode-option active" data-value="hybrid">Hybrid</div>
            <div class="mode-option" data-value="ongrid">On-grid</div>
            <div class="mode-option" data-value="offgrid">Off-grid</div>
          </div>
          <select id="mode" style="display: none;">
            <option value="hybrid">Hybrid</option>
            <option value="ongrid">On-grid</option>
            <option value="offgrid">Off-grid</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>House Load</label>
      <div class="input-with-unit">
        <input id="load" type="number" min="0" step="0.01" value="3" />
        <span class="unit">kW</span>
      </div>
    </div>

    <div class="form-group">
      <label>Desired Backup Hours</label>
      <div class="input-with-unit">
        <input id="backupHours" type="number" min="0.5" step="0.5" value="4" />
        <span class="unit">hrs</span>
      </div>
    </div>

    <div class="info-note">
      <strong>PV Charge Constraint Note:</strong> Battery is assumed charged only from PV through inverter. Maximum allowed charging time target: <code>5 hrs</code> (if calculated charge time &gt;5, a warning will be shown).
    </div>

    <button id="calcBtn" class="calculate-btn">
      <span>Calculate System</span>
      <span>‚Üí</span>
    </button>

    <div id="out" class="result-card" aria-live="polite"></div>

    <footer>Created by Milan Methnuwan</footer>
  </div>

  <script>
    // Constants
    const INVERTER_EFF = 0.97;
    const DOD = 0.9;

    // Data sets
    const singlePhase = {
      batteries: [
        { id: 'STE-MS5', voltage: 51.2, capacityAh: 100, kWh: (51.2 * 100) / 1000 },
        { id: 'STE-MS10', voltage: 51.2, capacityAh: 200, kWh: (51.2 * 200) / 1000 }
      ],
      inverters: [
        { id: 'STH-5KTL-LS-P', kW: 5, maxChargeA: 100, modes: ['ongrid', 'hybrid', 'offgrid'] },
        { id: 'STH-5KTL-LS', kW: 5, maxChargeA: 120, modes: ['ongrid', 'hybrid', 'offgrid'] }
      ],
      maxHybridOnGridCapacity_kW: 5
    };

    const threePhase = {
      batteries: [
        { id: 'STE-ES5', nominalV: 102.4, capacityAh: 50, kWh: (102.4 * 50) / 1000 },
        { id: 'STE-ES10', nominalV: 204.8, capacityAh: 50, kWh: (204.8 * 50) / 1000 },
        { id: 'STE-ES15', nominalV: 307.2, capacityAh: 50, kWh: (307.2 * 50) / 1000 },
        { id: 'STE-ES20', nominalV: 409.6, capacityAh: 50, kWh: (409.6 * 50) / 1000 },
        { id: 'STE-ES25', nominalV: 512.0, capacityAh: 50, kWh: (512.0 * 50) / 1000 },
        { id: 'STE-ES30', nominalV: 614.4, capacityAh: 50, kWh: (614.4 * 50) / 1000 },
        { id: 'STE-MS5', voltage: 51.2, capacityAh: 100, kWh: (51.2 * 100) / 1000 },
        { id: 'STE-MS10', voltage: 51.2, capacityAh: 200, kWh: (51.2 * 200) / 1000 }
      ],
      inverters: [
        {
          id: 'STH-10KTL-HTP', kW: 10, maxChargeA: 25,
          modes: ['ongrid', 'hybrid', 'offgrid'],
          allowedBatteries: ['STE-ES5', 'STE-ES10', 'STE-ES15', 'STE-ES20', 'STE-ES25', 'STE-ES30']
        },
        {
          id: 'STH-15KTL-HT', kW: 15, maxChargeA: 25,
          modes: ['ongrid', 'hybrid', 'offgrid'],
          allowedBatteries: ['STE-ES5', 'STE-ES10', 'STE-ES15', 'STE-ES20', 'STE-ES25', 'STE-ES30']
        }
      ]
    };

    // Common inverter shared for both
    const commonInverters = [
      { id: 'STH-8KTL-LS', kW: 8, maxChargeA: 160, modes: ['offgrid'], allowedBatteries: ['STE-MS5', 'STE-MS10'] },
	  { id: 'STH-5KTL-LS-P', kW: 5, maxChargeA: 100, modes: ['offgrid'], allowedBatteries: ['STE-MS5', 'STE-MS10'] },
	  { id: 'STH-5KTL-LS', kW: 8, maxChargeA: 120, modes: ['offgrid'], allowedBatteries: ['STE-MS5', 'STE-MS10'] }
    ];

    // Utility
    const safeNum = (v, f = 0) => {
      const n = parseFloat(v);
      return isNaN(n) ? f : n;
    };

    // Modern toggle functionality for mode selection
    const modeOptions = document.querySelectorAll('.mode-option');
    const modeSelect = document.getElementById('mode');
    
    modeOptions.forEach(option => {
      option.addEventListener('click', () => {
        modeOptions.forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        modeSelect.value = option.dataset.value;
      });
    });

    // Main calculator
    document.getElementById('calcBtn').addEventListener('click', () => {
      const phase = document.getElementById('phase').value;
      const mode = modeSelect.value;
      const loadKW = safeNum(document.getElementById('load').value, 0);
      const backupHours = safeNum(document.getElementById('backupHours').value, 4);
      const out = document.getElementById('out');
      out.classList.add('show');
      out.innerHTML = '';

      if (loadKW <= 0) {
        out.innerHTML = '<div class="warn">Please enter a valid house load (kW).</div>';
        return;
      }
      if (backupHours <= 0) {
        out.innerHTML = '<div class="warn">Please enter valid backup hours (>0).</div>';
        return;
      }

      // Select data without mutating source
      const baseData = (phase === 'single') ? singlePhase : threePhase;
      const data = {
        ...baseData,
        inverters: [...(baseData.inverters || []), ...commonInverters]
      };

      // Inverter recommendation
      const possibleInv = data.inverters.filter(inv => inv.modes.includes(mode));
      let invCandidates = possibleInv.filter(inv => {
        if (phase === 'single' && (mode === 'hybrid' || mode === 'ongrid')) {
          return inv.kW <= data.maxHybridOnGridCapacity_kW && inv.kW >= loadKW;
        }
        return inv.kW >= loadKW;
      });
      if (invCandidates.length === 0) {
        invCandidates = possibleInv.filter(inv => inv.kW >= loadKW);
      }
      invCandidates.sort((a, b) => a.kW - b.kW);
      const invRecommended = invCandidates.length ? invCandidates[0] : null;

      const maxAvailableKW = possibleInv.reduce((m, i) => Math.max(m, i.kW), 0);
      const needsSplit = loadKW > maxAvailableKW;

      // Battery calculations
      const requiredEnergy_kWh = loadKW * backupHours / INVERTER_EFF;
      const batteryOptions = data.batteries.map(b => {
        const V = b.voltage || b.nominalV;
        const module_kWh = b.kWh;
        const usable_kWh_per_module = module_kWh * DOD;
        const modulesNeeded = Math.ceil(requiredEnergy_kWh / usable_kWh_per_module);
        const totalModules_kWh = modulesNeeded * module_kWh;
        const usableTotal_kWh = totalModules_kWh * DOD;
        return { id: b.id, moduleVoltage: V, module_kWh, usable_kWh_per_module, modulesNeeded, totalModules_kWh, usableTotal_kWh };
      });

      function computeTimesForInverter(inv) {
        return batteryOptions.map(opt => {
          if (inv.allowedBatteries && !inv.allowedBatteries.includes(opt.id)) {
            return { ...opt, incompatible: true };
          }
          const V = opt.moduleVoltage;
          const maxChargePower_kW = (inv.maxChargeA * V) / 1000 * INVERTER_EFF;
          const chargeTimeHours = opt.totalModules_kWh / (maxChargePower_kW > 0 ? maxChargePower_kW : Infinity);
          const dischargeTimeHours = (opt.usableTotal_kWh * INVERTER_EFF) / (maxChargePower_kW > 0 ? maxChargePower_kW : Infinity);
          return { ...opt, maxChargePower_kW, chargeTimeHours, dischargeTimeHours };
        });
      }

      let timesByInv = null;
      if (invRecommended) timesByInv = computeTimesForInverter(invRecommended);
      else if (possibleInv.length) timesByInv = computeTimesForInverter(possibleInv[0]);
      else timesByInv = computeTimesForInverter(data.inverters[0]);

      // Build output
      let html = '';
      html += `<div class="result-header"><span>üìä</span><strong>System Analysis</strong></div>`;
      html += `<div class="result-details">Phase: <code>${phase}</code> ‚Ä¢ Mode: <code>${mode}</code> ‚Ä¢ Load: <code>${loadKW.toFixed(2)} kW</code> ‚Ä¢ Backup: <code>${backupHours} hrs</code></div>`;
      html += '<hr/>';
      html += '<div><strong>Inverter Recommendation</strong>';
      if (invRecommended) {
        html += `<div style="margin-top:8px">Recommended model: <code>${invRecommended.id}</code> ‚Äî ${invRecommended.kW} kW ‚Ä¢ Max charge/discharge: ${invRecommended.maxChargeA} A</div>`;
      } else {
        html += `<div class="warn">No inverter exactly matches constraints for selected phase/mode and load. Closest options:</div>`;
        if (invCandidates.length) {
          html += '<ul>' + invCandidates.map(i => `<li><code>${i.id}</code> ‚Äî ${i.kW} kW ‚Ä¢ MaxCharge ${i.maxChargeA} A</li>`).join('') + '</ul>';
        } else {
          html += '<div class="warn">No inverter available for selected configuration.</div>';
        }
      }
      if (needsSplit) {
        html += `<div class="warn" style="margin-top:8px">Load (${loadKW.toFixed(2)} kW) is higher than the maximum available inverter capacity (${maxAvailableKW} kW). <strong>Recommend splitting house wiring / separate sub-panel.</strong></div>`;
      }
      html += '</div><hr/>';

      html += '<div><strong>Battery Recommendations</strong>';
      html += '<div style="font-size:0.9rem;color:#475569;margin-top:6px">Calculations use battery DOD 90% and inverter efficiency 97%.</div>';
      html += '<table><thead><tr><th>Battery</th><th>Module kWh</th><th>Modules</th><th>Total kWh</th><th>Usable kWh</th><th>Discharge Time</th><th>Charge Time</th></tr></thead><tbody>';

      timesByInv.forEach(opt => {
        if (opt.incompatible) {
          html += `<tr><td><code>${opt.id}</code></td><td colspan="6" style="color:#b91c1c">Not compatible with recommended inverter</td></tr>`;
          return;
        }
        const ch = isFinite(opt.chargeTimeHours) ? opt.chargeTimeHours.toFixed(2) + ' hrs' : '‚Äî';
        const dh = isFinite(opt.dischargeTimeHours) ? opt.dischargeTimeHours.toFixed(2) + ' hrs' : '‚Äî';
        html += `<tr><td><code>${opt.id}</code></td><td>${opt.module_kWh.toFixed(2)}</td><td>${opt.modulesNeeded}</td><td>${opt.totalModules_kWh.toFixed(2)}</td><td>${opt.usableTotal_kWh.toFixed(2)}</td><td>${dh}</td><td>${ch}</td></tr>`;
      });

      html += '</tbody></table>';

      if (invRecommended) {
        const numericChargeTimes = timesByInv
          .map(o => o.chargeTimeHours)
          .filter(t => Number.isFinite(t));
        if (numericChargeTimes.length === 0) {
          html += `<div class="warn">Recommended inverter (<code>${invRecommended.id}</code>) isn't compatible with these battery options.</div>`;
        } else {
          const worstCharge = Math.max(...numericChargeTimes);
          if (worstCharge > 5) {
            html += `<div class="warn">Calculated charge time (some options) &gt; 5 hrs (${worstCharge.toFixed(2)} hrs). Consider higher PV size or higher current inverter.</div>`;
          } else {
            html += `<div class="ok">Calculated charge times are within 5 hrs for recommended inverter (<code>${invRecommended.id}</code>).</div>`;
          }
        }
      }

      html += '<hr/><div><strong>Additional Notes</strong><ul style="margin-top:8px"><li>Single-phase hybrid & on-grid max inverter capacity = <code>5 kW</code>. 8 kW single-phase model is off-grid only.</li><li>Single-phase inverters can be used in a three-phase system only in off-grid mode, if the house does not have any three-phase appliances.</li><li>Battery usable energy = module kWh √ó DOD (90%).</li><li>Charge power ‚âà inverter max charge A √ó battery V √ó efficiency.</li><li>If load &gt; inverter capacity, split circuits into sub-panels.</li></ul></div>';

      out.innerHTML = html;
    });
  </script>
</body>
</html>
