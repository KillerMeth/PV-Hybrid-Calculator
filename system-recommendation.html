<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hybrid System Calculator – Macksons Solar</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:24px;background:#f7fafc;color:#0f172a}
    .card{background:white;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);max-width:900px;margin:0 auto}
    h1{font-size:20px;margin:0 0 8px}
    label{display:block;margin-top:12px;font-size:13px}
    input[type="number"],select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e2e8f0;font-size:14px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    button{margin-top:16px;padding:10px 14px;border-radius:10px;border:0;background:#0ea5a3;color:white;font-weight:600;cursor:pointer}
    .result{margin-top:18px;padding:14px;border-radius:10px;background:#f1f5f9}
    .warn{color:#92400e;background:#fff7ed;padding:10px;border-radius:8px;margin-top:10px}
    .ok{color:#064e3b;background:#ecfdf5;padding:10px;border-radius:8px;margin-top:10px}
    code{background:#eef2ff;padding:2px 6px;border-radius:6px}
    footer{margin-top:18px;text-align:right;font-size:13px;color:#94a3b8}
    @media(max-width:700px){.row{flex-direction:column}}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px 6px;border-bottom:1px solid #e6eef6;text-align:left;font-size:13px}
    th{font-weight:700}
  </style>
</head>
<body>
  <div class="card">
    <h1>Hybrid System Sales Calculator – Macksons Solar</h1>
    <p style="margin:0 0 12px;color:#475569">Quickly recommend inverter & battery based on customer's house load. Change "Desired backup hours" if customer wants different autonomy.</p>

    <div class="row">
      <div class="col">
        <label>Phase</label>
        <select id="phase">
          <option value="single">Single Phase (Low Voltage)</option>
          <option value="three">Three Phase (High Voltage)</option>
        </select>
      </div>
      <div class="col">
        <label>System Mode</label>
        <select id="mode">
          <option value="hybrid">Hybrid</option>
          <option value="ongrid">On-grid</option>
          <option value="offgrid">Off-grid</option>
        </select>
      </div>
    </div>

    <label>House load (kW)</label>
    <input id="load" type="number" min="0" step="0.01" value="3" />

    <label>Desired backup hours (hrs) — default 4 (editable)</label>
    <input id="backupHours" type="number" min="0.5" step="0.5" value="4" />

    <label>PV charge constraint note</label>
    <div style="font-size:13px;color:#475569">Battery is assumed charged only from PV through inverter. Maximum allowed charging time target: <code>5 hrs</code> (if calculated charge time &gt;5, a warning will be shown).</div>

    <button id="calcBtn">Calculate</button>

    <div id="out" class="result" aria-live="polite" style="display:none"></div>

    <footer>Created by Milan Methnuwan</footer>
  </div>

  <script>
    // product & system constants
    const INVERTER_EFF = 0.97;
    const DOD = 0.9;

    const singlePhase = {
      batteries: [
        {id:'STE-MS5', voltage:51.2, capacityAh:100, kWh: (51.2*100)/1000}, // 5.12 kWh
        {id:'STE-MS10', voltage:51.2, capacityAh:200, kWh: (51.2*200)/1000} // 10.24 kWh (parallel possible)
      ],
      inverters: [
        {id:'STH-5KTL-LS-P', kW:5, maxChargeA:100, modes:['ongrid','hybrid','offgrid']},
        {id:'STH-5KTL-LS', kW:5, maxChargeA:120, modes:['ongrid','hybrid','offgrid']},
        {id:'STH-8KTL-LS', kW:8, maxChargeA:160, modes:['offgrid']} // only offgrid
      ],
      maxHybridOnGridCapacity_kW:5
    };

    const threePhase = {
      batteries: [
        // module nominal voltages (stackable modules produce nominal stacks)
        {id:'STE-ES5', nominalV:102.4, capacityAh:50, kWh: (102.4*50)/1000},   // 5.12 kWh
        {id:'STE-ES10', nominalV:204.8, capacityAh:50, kWh: (204.8*50)/1000},  //10.24
        {id:'STE-ES15', nominalV:307.2, capacityAh:50, kWh: (307.2*50)/1000},  //15.36
        {id:'STE-ES20', nominalV:409.6, capacityAh:50, kWh: (409.6*50)/1000},  //20.48
        {id:'STE-ES25', nominalV:512.0, capacityAh:50, kWh: (512.0*50)/1000},  //25.6
        {id:'STE-ES30', nominalV:614.4, capacityAh:50, kWh: (614.4*50)/1000}   //30.72
      ],
      inverters: [
        {id:'STH-10KTL-HTP', kW:10, maxChargeA:25, modes:['ongrid','hybrid','offgrid'], batteryVoltageRange:[141,750]},
        {id:'STH-15KTL-HT', kW:15, maxChargeA:25, modes:['ongrid','hybrid','offgrid'], batteryVoltageRange:[200,800]}
      ]
    };

    // helper
    function safeNum(v, fallback=0){ const n = parseFloat(v); return isNaN(n)?fallback:n; }

    document.getElementById('calcBtn').addEventListener('click', ()=>{
      const phase = document.getElementById('phase').value;
      const mode = document.getElementById('mode').value;
      const loadKW = safeNum(document.getElementById('load').value, 0);
      const backupHours = safeNum(document.getElementById('backupHours').value, 4);

      const out = document.getElementById('out');
      out.style.display='block';
      out.innerHTML = '';

      if(loadKW <= 0){
        out.innerHTML = '<div class="warn">Please enter a valid house load (kW).</div>';
        return;
      }
      if(backupHours <= 0){
        out.innerHTML = '<div class="warn">Please enter a valid backup hours (>0).</div>';
        return;
      }

      // choose data source
      const data = (phase==='single') ? singlePhase : threePhase;

      // 1) Recommend inverter(s)
      const possibleInv = data.inverters.filter(inv => inv.modes.includes(mode));
      // For single-phase hybrid/ongrid cap limit
      let invCandidates = possibleInv.filter(inv=>{
        if(phase==='single' && (mode==='hybrid' || mode==='ongrid')){
          return inv.kW <= data.maxHybridOnGridCapacity_kW && inv.kW >= loadKW;
        }
        return inv.kW >= loadKW;
      });
      // relax rule if none
      if(invCandidates.length === 0){
        invCandidates = possibleInv.filter(inv => inv.kW >= loadKW);
      }
      invCandidates.sort((a,b)=>a.kW-b.kW);
      let invRecommended = invCandidates.length ? invCandidates[0] : null;

      // If load exceeds all inverter kW capacities, recommend splitting house wiring
      const maxAvailableKW = possibleInv.reduce((m,i)=>Math.max(m,i.kW), 0);
      const needsSplit = loadKW > maxAvailableKW;

      // 2) Battery sizing (required energy accounting inverter eff & DOD)
      // requiredEnergy_kWh = loadKW * backupHours / inverter_eff (because inverter losses reduce delivered AC from battery)
      const requiredEnergy_kWh = loadKW * backupHours / INVERTER_EFF;

      const batteryOptions = data.batteries.map(b=>{
        const moduleVoltage = b.voltage || b.nominalV; // single uses 'voltage', three uses 'nominalV'
        const module_kWh = b.kWh;
        const usable_kWh_per_module = module_kWh * DOD;
        const modulesNeeded = Math.ceil(requiredEnergy_kWh / usable_kWh_per_module);
        const totalModules_kWh = modulesNeeded * module_kWh;
        const usableTotal_kWh = totalModules_kWh * DOD;
        return {
          id: b.id,
          moduleVoltage,
          module_kWh,
          usable_kWh_per_module,
          modulesNeeded,
          totalModules_kWh,
          usableTotal_kWh
        };
      });

      // compute charge/discharge times depending on inverter chosen (or fallback)
      function computeTimesForInverter(inv){
        return batteryOptions.map(opt=>{
          const V = opt.moduleVoltage;
          // charge power in kW from inverter (maxChargeA × V /1000) * inverter_eff (charging through inverter losses)
          const maxChargePower_kW = (inv.maxChargeA * V)/1000 * INVERTER_EFF;
          const chargeTimeHours = (opt.totalModules_kWh) / (maxChargePower_kW > 0 ? maxChargePower_kW : Infinity);
          // energy available to AC load when discharging = usableTotal_kWh * inverter_eff
          const dischargeTimeHours = (opt.usableTotal_kWh * INVERTER_EFF) / loadKW;
          return Object.assign({}, opt, { maxChargePower_kW, chargeTimeHours, dischargeTimeHours });
        });
      }

      let timesByInv = null;
      if(invRecommended){
        timesByInv = computeTimesForInverter(invRecommended);
      } else if(possibleInv.length){
        timesByInv = computeTimesForInverter(possibleInv[0]);
      } else {
        // no inverter at all for this mode (unlikely) -> use first inverter as fallback
        timesByInv = computeTimesForInverter(data.inverters[0]);
      }

      // Build output HTML
      let html = '';
      html += `<div><strong>Inputs</strong><div style="margin-top:6px;color:#334155">Phase: <code>${phase}</code> • Mode: <code>${mode}</code> • Load: <code>${loadKW.toFixed(2)} kW</code> • Backup: <code>${backupHours} hrs</code></div></div>`;
      html += '<hr/>';
      html += '<div><strong>Inverter recommendation</strong>';
      if(invRecommended){
        html += `<div style="margin-top:8px">Recommended model: <code>${invRecommended.id}</code> — ${invRecommended.kW} kW • Max charge/discharge: ${invRecommended.maxChargeA} A</div>`;
      } else {
        html += `<div class="warn">No inverter exactly matches constraints for selected phase/mode and load. Closest options:</div>`;
        if(invCandidates.length){
          html += '<ul>' + invCandidates.map(i=>`<li><code>${i.id}</code> — ${i.kW} kW • MaxCharge ${i.maxChargeA} A</li>`).join('') + '</ul>';
        } else {
          html += '<div class="warn">No inverter available for selected configuration.</div>';
        }
      }
      if(needsSplit){
        html += `<div class="warn" style="margin-top:8px">Load (${loadKW.toFixed(2)} kW) is higher than the maximum available inverter capacity (${maxAvailableKW} kW) for the selected mode. <strong>Recommend splitting house wiring / separate sub-panel</strong> to match inverter capacity.</div>`;
      }
      html += '</div>';

      html += '<hr/>';
      html += '<div><strong>Battery recommendations (per module options)</strong>';
      html += '<div style="font-size:13px;color:#475569;margin-top:6px">Calculations use battery DOD 90% and inverter efficiency 97%.</div>';

      html += '<table><thead><tr><th>Battery</th><th>Module kWh</th><th>Modules needed</th><th>Total kWh</th><th>Usable kWh (DOD)</th><th>Discharge hrs @ load or Grid</th><th>Charge hrs (from PV, based on inverter)</th></tr></thead><tbody>';

      timesByInv.forEach(opt=>{
        const chargeTime = isFinite(opt.chargeTimeHours) ? opt.chargeTimeHours : Infinity;
        const dischargeTime = isFinite(opt.dischargeTimeHours) ? opt.dischargeTimeHours : 0;

        html += `<tr><td><code>${opt.id}</code></td><td>${opt.module_kWh.toFixed(2)} kWh</td><td>${opt.modulesNeeded}</td><td>${opt.totalModules_kWh.toFixed(2)} kWh</td><td>${opt.usableTotal_kWh.toFixed(2)} kWh</td><td>${dischargeTime.toFixed(2)} hrs</td><td>${chargeTime===Infinity? '—': chargeTime.toFixed(2) + ' hrs'}</td></tr>`;
      });

      html += '</tbody></table>';

      // warn if charge time >5hrs
      if(invRecommended){
        const worstCharge = Math.max(...timesByInv.map(o=>o.chargeTimeHours));
        if(worstCharge > 5){
          html += `<div class="warn">Calculated charge time (some battery options) &gt; 5 hrs (${worstCharge.toFixed(2)} hrs). Because charging only from PV, consider increasing PV size or choose battery/inverter with higher charge current.</div>`;
        } else {
          html += `<div class="ok">Calculated charge times are within 5 hrs for recommended inverter (<code>${invRecommended.id}</code>).</div>`;
        }
      }

      // Additional guidance
      html += '<hr/>';
      html += `<div><strong>Additional notes / quick rules</strong><ul style="margin-top:8px"><li>Single-phase hybrid & on-grid max inverter capacity set to <code>5 kW</code>. 8 kW single-phase model is for off-grid only.</li><li>Battery usable energy = module kWh × DOD (90%). Discharge time = usable energy × inverter efficiency ÷ load.</li><li>Charge power estimated from inverter max charge current × battery nominal voltage × inverter efficiency.</li><li>If load > inverter capacity, split house wiring into sub-circuits to match inverter ratings.</li></ul></div>`;

      out.innerHTML = html;
    });
  </script>
</body>
</html>
