<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hybrid System Calculator ‚Äì Macksons Solar</title>
  <style>
    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      margin: 24px;
      background: #f7fafc;
      color: #0f172a;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      max-width: 900px;
      margin: 0 auto;
      position: relative;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }

    label {
      display: block;
      margin-top: 12px;
      font-size: 13px;
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .col {
      flex: 1;
    }

    button {
      margin-top: 16px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 0;
      background: #0ea5a3;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #0c9693;
    }

    .result {
      margin-top: 18px;
      padding: 14px;
      border-radius: 10px;
      background: #f1f5f9;
    }

    .warn {
      color: #92400e;
      background: #fff7ed;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }

    .ok {
      color: #064e3b;
      background: #ecfdf5;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }

    code {
      background: #eef2ff;
      padding: 2px 6px;
      border-radius: 6px;
    }

    footer {
      margin-top: 18px;
      text-align: right;
      font-size: 13px;
      color: #94a3b8;
    }

    @media(max-width:700px) {
      .row {
        flex-direction: column;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #e6eef6;
      text-align: left;
      font-size: 13px;
    }

    th {
      font-weight: 700;
    }

    /* Home button style */
    .home-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #0ea5a3;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    .home-btn:hover {
      background: #0c9693;
    }
  </style>
</head>

<body>
  <div class="card">
    <a href="index.html" class="home-btn">üè† Home</a>
    <h1>Hybrid System Calculator ‚Äì Macksons Solar</h1>
    <p style="margin:0 0 12px;color:#475569">
      Quickly recommend inverter & battery based on customer's house load.
      Change "Desired backup hours" if customer wants different autonomy.
    </p>

    <div class="row">
      <div class="col">
        <label>Phase</label>
        <select id="phase">
          <option value="single">Single Phase (Low Voltage)</option>
          <option value="three">Three Phase (High Voltage)</option>
        </select>
      </div>
      <div class="col">
        <label>System Mode</label>
        <select id="mode">
          <option value="hybrid">Hybrid</option>
          <option value="ongrid">On-grid</option>
          <option value="offgrid">Off-grid</option>
        </select>
      </div>
    </div>

    <label>House load (kW)</label>
    <input id="load" type="number" min="0" step="0.01" value="3" />

    <label>Desired backup hours (hrs)</label>
    <input id="backupHours" type="number" min="0.5" step="0.5" value="4" />

    <label>PV charge constraint note</label>
    <div style="font-size:13px;color:#475569">
      Battery is assumed charged only from PV through inverter. Maximum allowed
      charging time target: <code>5 hrs</code> (if calculated charge time
      &gt;5, a warning will be shown).
    </div>

    <button id="calcBtn">Calculate</button>

    <div id="out" class="result" aria-live="polite" style="display:none"></div>

    <footer>Created by Milan Methnuwan</footer>
  </div>

  <script>
    // Constants
    const INVERTER_EFF = 0.97;
    const DOD = 0.9;

    // Data sets
    const singlePhase = {
      batteries: [
        { id: 'STE-MS5', voltage: 51.2, capacityAh: 100, kWh: (51.2 * 100) / 1000 },
        { id: 'STE-MS10', voltage: 51.2, capacityAh: 200, kWh: (51.2 * 200) / 1000 }
      ],
      inverters: [
        { id: 'STH-5KTL-LS-P', kW: 5, maxChargeA: 100, modes: ['ongrid', 'hybrid', 'offgrid'] },
        { id: 'STH-5KTL-LS', kW: 5, maxChargeA: 120, modes: ['ongrid', 'hybrid', 'offgrid'] }
      ],
      maxHybridOnGridCapacity_kW: 5
    };

    const threePhase = {
      batteries: [
        { id: 'STE-ES5', nominalV: 102.4, capacityAh: 50, kWh: (102.4 * 50) / 1000 },
        { id: 'STE-ES10', nominalV: 204.8, capacityAh: 50, kWh: (204.8 * 50) / 1000 },
        { id: 'STE-ES15', nominalV: 307.2, capacityAh: 50, kWh: (307.2 * 50) / 1000 },
        { id: 'STE-ES20', nominalV: 409.6, capacityAh: 50, kWh: (409.6 * 50) / 1000 },
        { id: 'STE-ES25', nominalV: 512.0, capacityAh: 50, kWh: (512.0 * 50) / 1000 },
        { id: 'STE-ES30', nominalV: 614.4, capacityAh: 50, kWh: (614.4 * 50) / 1000 },
        { id: 'STE-MS5', voltage: 51.2, capacityAh: 100, kWh: (51.2 * 100) / 1000 },
        { id: 'STE-MS10', voltage: 51.2, capacityAh: 200, kWh: (51.2 * 200) / 1000 }
      ],
      inverters: [
        {
          id: 'STH-10KTL-HTP', kW: 10, maxChargeA: 25,
          modes: ['ongrid', 'hybrid', 'offgrid'],
          allowedBatteries: ['STE-ES5', 'STE-ES10', 'STE-ES15', 'STE-ES20', 'STE-ES25', 'STE-ES30']
        },
        {
          id: 'STH-15KTL-HT', kW: 15, maxChargeA: 25,
          modes: ['ongrid', 'hybrid', 'offgrid'],
          allowedBatteries: ['STE-ES5', 'STE-ES10', 'STE-ES15', 'STE-ES20', 'STE-ES25', 'STE-ES30']
        }
      ]
    };

    // Common inverter shared for both
    const commonInverters = [
      { id: 'STH-8KTL-LS', kW: 8, maxChargeA: 160, modes: ['offgrid'], allowedBatteries: ['STE-MS5', 'STE-MS10'] },
	  { id: 'STH-5KTL-LS-P', kW: 5, maxChargeA: 100, modes: ['offgrid'], allowedBatteries: ['STE-MS5', 'STE-MS10'] },
	  { id: 'STH-5KTL-LS', kW: 8, maxChargeA: 120, modes: ['offgrid'], allowedBatteries: ['STE-MS5', 'STE-MS10'] }
    ];

    // Utility
    const safeNum = (v, f = 0) => {
      const n = parseFloat(v);
      return isNaN(n) ? f : n;
    };

    // Main calculator
    document.getElementById('calcBtn').addEventListener('click', () => {
      const phase = document.getElementById('phase').value;
      const mode = document.getElementById('mode').value;
      const loadKW = safeNum(document.getElementById('load').value, 0);
      const backupHours = safeNum(document.getElementById('backupHours').value, 4);
      const out = document.getElementById('out');
      out.style.display = 'block';
      out.innerHTML = '';

      if (loadKW <= 0) {
        out.innerHTML = '<div class="warn">Please enter a valid house load (kW).</div>';
        return;
      }
      if (backupHours <= 0) {
        out.innerHTML = '<div class="warn">Please enter valid backup hours (>0).</div>';
        return;
      }

      // Select data without mutating source
      const baseData = (phase === 'single') ? singlePhase : threePhase;
      const data = {
        ...baseData,
        inverters: [...(baseData.inverters || []), ...commonInverters]
      };

      // Inverter recommendation
      const possibleInv = data.inverters.filter(inv => inv.modes.includes(mode));
      let invCandidates = possibleInv.filter(inv => {
        if (phase === 'single' && (mode === 'hybrid' || mode === 'ongrid')) {
          return inv.kW <= data.maxHybridOnGridCapacity_kW && inv.kW >= loadKW;
        }
        return inv.kW >= loadKW;
      });
      if (invCandidates.length === 0) {
        invCandidates = possibleInv.filter(inv => inv.kW >= loadKW);
      }
      invCandidates.sort((a, b) => a.kW - b.kW);
      const invRecommended = invCandidates.length ? invCandidates[0] : null;

      const maxAvailableKW = possibleInv.reduce((m, i) => Math.max(m, i.kW), 0);
      const needsSplit = loadKW > maxAvailableKW;

      // Battery calculations
      const requiredEnergy_kWh = loadKW * backupHours / INVERTER_EFF;
      const batteryOptions = data.batteries.map(b => {
        const V = b.voltage || b.nominalV;
        const module_kWh = b.kWh;
        const usable_kWh_per_module = module_kWh * DOD;
        const modulesNeeded = Math.ceil(requiredEnergy_kWh / usable_kWh_per_module);
        const totalModules_kWh = modulesNeeded * module_kWh;
        const usableTotal_kWh = totalModules_kWh * DOD;
        return { id: b.id, moduleVoltage: V, module_kWh, usable_kWh_per_module, modulesNeeded, totalModules_kWh, usableTotal_kWh };
      });

      function computeTimesForInverter(inv) {
        return batteryOptions.map(opt => {
          if (inv.allowedBatteries && !inv.allowedBatteries.includes(opt.id)) {
            return { ...opt, incompatible: true };
          }
          const V = opt.moduleVoltage;
          const maxChargePower_kW = (inv.maxChargeA * V) / 1000 * INVERTER_EFF;
          const chargeTimeHours = opt.totalModules_kWh / (maxChargePower_kW > 0 ? maxChargePower_kW : Infinity);
          const dischargeTimeHours = (opt.usableTotal_kWh * INVERTER_EFF) / (maxChargePower_kW > 0 ? maxChargePower_kW : Infinity);
          return { ...opt, maxChargePower_kW, chargeTimeHours, dischargeTimeHours };
        });
      }

      let timesByInv = null;
      if (invRecommended) timesByInv = computeTimesForInverter(invRecommended);
      else if (possibleInv.length) timesByInv = computeTimesForInverter(possibleInv[0]);
      else timesByInv = computeTimesForInverter(data.inverters[0]);

      // Build output
      let html = '';
      html += `<div><strong>Inputs</strong><div style="margin-top:6px;color:#334155">Phase: <code>${phase}</code> ‚Ä¢ Mode: <code>${mode}</code> ‚Ä¢ Load: <code>${loadKW.toFixed(2)} kW</code> ‚Ä¢ Backup: <code>${backupHours} hrs</code></div></div>`;
      html += '<hr/>';
      html += '<div><strong>Inverter recommendation</strong>';
      if (invRecommended) {
        html += `<div style="margin-top:8px">Recommended model: <code>${invRecommended.id}</code> ‚Äî ${invRecommended.kW} kW ‚Ä¢ Max charge/discharge: ${invRecommended.maxChargeA} A</div>`;
      } else {
        html += `<div class="warn">No inverter exactly matches constraints for selected phase/mode and load. Closest options:</div>`;
        if (invCandidates.length) {
          html += '<ul>' + invCandidates.map(i => `<li><code>${i.id}</code> ‚Äî ${i.kW} kW ‚Ä¢ MaxCharge ${i.maxChargeA} A</li>`).join('') + '</ul>';
        } else {
          html += '<div class="warn">No inverter available for selected configuration.</div>';
        }
      }
      if (needsSplit) {
        html += `<div class="warn" style="margin-top:8px">Load (${loadKW.toFixed(2)} kW) is higher than the maximum available inverter capacity (${maxAvailableKW} kW). <strong>Recommend splitting house wiring / separate sub-panel.</strong></div>`;
      }
      html += '</div><hr/>';

      html += '<div><strong>Battery recommendations (per module options)</strong>';
      html += '<div style="font-size:13px;color:#475569;margin-top:6px">Calculations use battery DOD 90% and inverter efficiency 97%.</div>';
      html += '<table><thead><tr><th>Battery</th><th>Module kWh</th><th>Modules needed</th><th>Total kWh</th><th>Usable kWh (DOD)</th><th>Discharge hrs @ load or grid</th><th>Charge hrs (from PV)</th></tr></thead><tbody>';

      timesByInv.forEach(opt => {
        if (opt.incompatible) {
          html += `<tr><td><code>${opt.id}</code></td><td colspan="6" style="color:#b91c1c">Not compatible with recommended inverter</td></tr>`;
          return;
        }
        const ch = isFinite(opt.chargeTimeHours) ? opt.chargeTimeHours.toFixed(2) + ' hrs' : '‚Äî';
        const dh = isFinite(opt.dischargeTimeHours) ? opt.dischargeTimeHours.toFixed(2) + ' hrs' : '‚Äî';
        html += `<tr><td><code>${opt.id}</code></td><td>${opt.module_kWh.toFixed(2)} kWh</td><td>${opt.modulesNeeded}</td><td>${opt.totalModules_kWh.toFixed(2)} kWh</td><td>${opt.usableTotal_kWh.toFixed(2)} kWh</td><td>${dh}</td><td>${ch}</td></tr>`;
      });

      html += '</tbody></table>';

      if (invRecommended) {
        const numericChargeTimes = timesByInv
          .map(o => o.chargeTimeHours)
          .filter(t => Number.isFinite(t));
        if (numericChargeTimes.length === 0) {
          html += `<div class="warn">Recommended inverter (<code>${invRecommended.id}</code>) isn't compatible with these battery options.</div>`;
        } else {
          const worstCharge = Math.max(...numericChargeTimes);
          if (worstCharge > 5) {
            html += `<div class="warn">Calculated charge time (some options) &gt; 5 hrs (${worstCharge.toFixed(2)} hrs). Consider higher PV size or higher current inverter.</div>`;
          } else {
            html += `<div class="ok">Calculated charge times are within 5 hrs for recommended inverter (<code>${invRecommended.id}</code>).</div>`;
          }
        }
      }

      html += '<hr/><div><strong>Additional notes</strong><ul style="margin-top:8px"><li>Single-phase hybrid & on-grid max inverter capacity = <code>5 kW</code>. 8 kW single-phase model is off-grid only.</li><li>Single-phase inverters can be used in a three-phase system only in off-grid mode, if the house does not have any three-phase appliances.</li><li>Battery usable energy = module kWh √ó DOD (90%).</li><li>Charge power ‚âà inverter max charge A √ó battery V √ó efficiency.</li><li>If load &gt; inverter capacity, split circuits into sub-panels.</li></ul></div>';

      out.innerHTML = html;
    });
  </script>
</body>

</html>


